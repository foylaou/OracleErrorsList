name: Multi-Platform Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            executable: main
            rename_cmd: mv dist/main dist/main-linux-x64
          - os: windows-latest
            platform: windows
            arch: x64
            executable: main.exe
            rename_cmd: Move-Item dist\main.exe dist\main-windows-x64.exe
          - os: macos-latest
            platform: macos
            arch: x64
            executable: main
            rename_cmd: mv dist/main dist/main-macos-x64

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install dependencies (Unix)
      if: runner.os != 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if (Test-Path requirements.txt) { pip install -r requirements.txt }

    - name: Build with PyInstaller
      run: |
        pyinstaller main.py --onefile --clean

    - name: Rename executable (Unix)
      if: runner.os != 'Windows'
      run: ${{ matrix.rename_cmd }}

    - name: Rename executable (Windows)
      if: runner.os == 'Windows'
      run: ${{ matrix.rename_cmd }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-${{ matrix.arch }}-build
        path: dist/
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release files
      run: |
        mkdir -p release_files
        # 複製所有平台的可執行檔案到 release_files 目錄
        find artifacts/ -name "main-*" -type f -exec cp {} release_files/ \;
        ls -la release_files/

    - name: Set up release variables
      id: vars
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "release_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "tag_name=latest" >> $GITHUB_OUTPUT
          echo "release_name=Latest Development Build" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        fi
        echo "commit_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

    - name: Delete existing latest release and tag (if exists)
      if: steps.vars.outputs.tag_name == 'latest'
      run: |
        gh release delete latest --yes || true
        git push --delete origin latest || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create/Update latest tag
      if: steps.vars.outputs.tag_name == 'latest'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -f latest
        git push -f origin latest

    - name: Generate release notes
      id: release_notes
      run: |
        if [[ "${{ steps.vars.outputs.tag_name }}" == "latest" ]]; then
          cat << EOF > release_notes.md
        ## Latest Development Build
        
        This is an automated build from the latest commit on the main branch.
        
        **Commit:** ${{ steps.vars.outputs.commit_sha }}
        **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ### Available Platforms
        - Linux x64
        - Windows x64  
        - macOS x64
        
        > ⚠️ This is a development build and may be unstable.
        EOF
        else
          cat << EOF > release_notes.md
        ## Release ${{ steps.vars.outputs.tag_name }}
        
        **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ### Available Platforms
        - Linux x64
        - Windows x64
        - macOS x64
        
        ### Changes
        - Built from commit ${{ steps.vars.outputs.commit_sha }}
        EOF
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.vars.outputs.tag_name }}
        name: ${{ steps.vars.outputs.release_name }}
        body_path: release_notes.md
        files: |
          release_files/main-linux-x64
          release_files/main-windows-x64.exe
          release_files/main-macos-x64
        prerelease: ${{ steps.vars.outputs.is_prerelease }}
        make_latest: ${{ steps.vars.outputs.tag_name != 'latest' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}